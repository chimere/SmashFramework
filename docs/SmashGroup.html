<!DOCTYPE html>  <html> <head>   <title>SmashGroup.as</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">        <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                        </div>         </div>       </div>      <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs" colspan="2">             <h1>               SmashGroup.as             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">package</span> <span class="nx">io</span><span class="p">.</span><span class="nx">smash</span><span class="p">.</span><span class="nx">core</span>
<span class="p">{</span>
    <span class="kd">import</span> <span class="nx">avmplus</span><span class="p">.</span><span class="nx">getQualifiedClassName</span><span class="o">;</span>

    <span class="kd">import</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">registerClassAlias</span><span class="o">;</span>

    <span class="kd">import</span> <span class="nx">io</span><span class="p">.</span><span class="nx">smash</span><span class="p">.</span><span class="nx">Smash</span><span class="o">;</span>
    <span class="kd">import</span> <span class="nx">io</span><span class="p">.</span><span class="nx">smash</span><span class="p">.</span><span class="nx">debug</span><span class="p">.</span><span class="nx">Logger</span><span class="o">;</span>
    <span class="kd">import</span> <span class="nx">io</span><span class="p">.</span><span class="nx">smash</span><span class="p">.</span><span class="nx">smash_internal</span><span class="o">;</span>
    <span class="kd">import</span> <span class="nx">io</span><span class="p">.</span><span class="nx">smash</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Injector</span><span class="o">;</span>


    <span class="nx">use</span> <span class="kd">namespace</span> <span class="nx">smash_internal</span><span class="o">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>SmashGroup provides lifecycle functionality (SmashObjects in it are destroy()ed
when it is destroy()ed), as well as dependency injection (see
registerManager).</p>

<p>SmashGroups are unique because they don't require an owningGroup to
be initialize()ed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">class</span> <span class="nx">SmashGroup</span> <span class="kd">extends</span> <span class="nx">SmashObject</span>
    <span class="p">{</span>
        <span class="kd">protected</span> <span class="k">var</span> <span class="nx">_items</span><span class="o">:</span><span class="nx">Vector</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">SmashObject</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vector</span><span class="p">.</span><span class="o">&lt;</span><span class="nx">SmashObject</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="kd">protected</span> <span class="k">var</span> <span class="nx">_injector</span><span class="o">:</span><span class="nx">Injector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">SmashGroup</span><span class="p">(</span><span class="nx">_name</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">super</span><span class="p">(</span><span class="nx">_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">smash_internal</span> <span class="kd">function</span> <span class="kd">get</span> <span class="nx">injector</span><span class="p">()</span><span class="o">:</span><span class="nx">Injector</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_injector</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">_injector</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">owningGroup</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">owningGroup</span><span class="p">.</span><span class="nx">injector</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Does this SmashGroup directly contain the specified object?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">final</span> <span class="kd">function</span> <span class="nx">contains</span><span class="p">(</span><span class="nx">object</span><span class="o">:</span><span class="nx">SmashObject</span><span class="p">)</span><span class="o">:</span><span class="nb">Boolean</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">owningGroup</span> <span class="o">==</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>How many SmashObjects are in this group?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">final</span> <span class="kd">function</span> <span class="kd">get</span> <span class="nx">length</span><span class="p">()</span><span class="o">:</span><span class="nb">int</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_items</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Return the SmashObject at the specified index.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">final</span> <span class="kd">function</span> <span class="nx">getSmashObjectAt</span><span class="p">(</span><span class="nx">index</span><span class="o">:</span><span class="nb">int</span><span class="p">)</span><span class="o">:</span><span class="nx">SmashObject</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_items</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="kd">public</span> <span class="kd">override</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Groups can stand alone so don't do the _owningGroup check in the parent class.
super.initialize();</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>If no owning group, add to the global list for debug purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="nx">owningGroup</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>todo add root group error</p>             </td>             <td class="code">               <div class="highlight"><pre>				
                <span class="nx">owningGroup</span> <span class="o">=</span> <span class="nx">Smash</span><span class="p">.</span><span class="nx">_rootGroup</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">_injector</span><span class="p">)</span>
                    <span class="nx">_injector</span><span class="p">.</span><span class="nx">setParentInjector</span><span class="p">(</span><span class="nx">owningGroup</span><span class="p">.</span><span class="nx">injector</span><span class="p">);</span>

                <span class="nx">owningGroup</span><span class="p">.</span><span class="nx">injectInto</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">public</span> <span class="kd">override</span> <span class="kd">function</span> <span class="nx">destroy</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span>
            <span class="kd">super</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Wipe the items.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">while</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">getSmashObjectAt</span><span class="p">(</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">destroy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Shut down the managers we own.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="nx">_injector</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span><span class="p">(</span><span class="k">var</span> <span class="nx">key</span><span class="o">:*</span> <span class="k">in</span> <span class="nx">_injector</span><span class="p">.</span><span class="nx">mappedValues</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kd">const</span> <span class="nx">val</span><span class="o">:*</span> <span class="o">=</span> <span class="nx">_injector</span><span class="p">.</span><span class="nx">mappedValues</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">val</span> <span class="nx">is</span> <span class="nx">ISmashManager</span><span class="p">)</span>
                        <span class="p">(</span><span class="nx">val</span> <span class="nx">as</span> <span class="nx">ISmashManager</span><span class="p">).</span><span class="nx">destroy</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">smash_internal</span> <span class="kd">function</span> <span class="nx">noteRemove</span><span class="p">(</span><span class="nx">object</span><span class="o">:</span><span class="nx">SmashObject</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Get it out of the list.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">var</span> <span class="nx">idx</span><span class="o">:</span><span class="nb">int</span> <span class="o">=</span> <span class="nx">_items</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find SmashObject in SmashGroup! Inconsistent group membership!&quot;</span><span class="p">);</span>
            <span class="nx">_items</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="o">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">smash_internal</span> <span class="kd">function</span> <span class="nx">noteAdd</span><span class="p">(</span><span class="nx">object</span><span class="o">:</span><span class="nx">SmashObject</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span>
            <span class="nx">_items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">protected</span> <span class="kd">function</span> <span class="nx">initInjection</span><span class="p">()</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_injector</span><span class="p">)</span>
                <span class="k">return</span><span class="o">;</span>

            <span class="nx">_injector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Injector</span><span class="p">();</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">owningGroup</span><span class="p">)</span>
                <span class="nx">_injector</span><span class="p">.</span><span class="nx">setParentInjector</span><span class="p">(</span><span class="nx">owningGroup</span><span class="p">.</span><span class="nx">injector</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Add a manager, which is used to fulfill dependencies for the specified
clazz. If the "manager" implements the ISmashManager interface, then
initialize() is called at this time. When the SmashGroup's destroy()
method is called, then destroy() is called on the manager if it
implements ISmashManager. Injection is also done on the manager when it
is registered.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">registerManager</span><span class="p">(</span><span class="nx">clazz</span><span class="o">:</span><span class="nb">Class</span><span class="o">,</span> <span class="nx">instance</span><span class="o">:*</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>register a short name for the manager, this is mainly used for tooling</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">var</span> <span class="nx">shortName</span><span class="o">:</span><span class="nb">String</span> <span class="o">=</span> <span class="nx">getQualifiedClassName</span><span class="p">(</span><span class="nx">clazz</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">registerClassAlias</span><span class="p">(</span><span class="nx">shortName</span><span class="o">,</span><span class="nx">clazz</span><span class="p">);</span>

            <span class="nx">initInjection</span><span class="p">();</span>
            <span class="nx">_injector</span><span class="p">.</span><span class="nx">mapValue</span><span class="p">(</span><span class="nx">instance</span><span class="o">,</span> <span class="nx">clazz</span><span class="p">);</span>
            <span class="nx">_injector</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">instance</span> <span class="nx">is</span> <span class="nx">ISmashManager</span><span class="p">)</span>
                <span class="p">(</span><span class="nx">instance</span> <span class="nx">as</span> <span class="nx">ISmashManager</span><span class="p">).</span><span class="nx">initialize</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Get a previously registered manager.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">getManager</span><span class="p">(</span><span class="nx">clazz</span><span class="o">:</span><span class="nb">Class</span><span class="p">)</span><span class="o">:*</span>
        <span class="p">{</span>
            <span class="k">var</span> <span class="nx">res</span><span class="o">:*</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="nx">res</span> <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nx">getMapping</span><span class="p">(</span><span class="nx">clazz</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find manager &quot;</span> <span class="o">+</span> <span class="nx">clazz</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span><span class="p">);</span>

            <span class="k">return</span> <span class="nx">res</span><span class="o">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Perform dependency injection on the specified object using this
SmashGroup's injection mappings.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">injectInto</span><span class="p">(</span><span class="nx">object</span><span class="o">:*</span><span class="p">)</span><span class="o">:</span><span class="nx">void</span>
        <span class="p">{</span>
            <span class="nx">injector</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">public</span> <span class="kd">function</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="nb">String</span><span class="p">)</span><span class="o">:</span><span class="nx">SmashObject</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="k">each</span><span class="p">(</span><span class="k">var</span> <span class="nx">go</span><span class="o">:</span><span class="nx">SmashObject</span> <span class="k">in</span> <span class="nx">_items</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">go</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nx">go</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="nx">Logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">SmashGroup</span><span class="o">,</span> <span class="s2">&quot;lookup&quot;</span><span class="o">,</span> <span class="s2">&quot;lookup failed! GameObject by the name of &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; does not exist&quot;</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>return owningGroup.lookup(name);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 